---
title: "03_ordination_diversity"
author: "Daniel"
date: "27/09/2022"
output: github_document
---


```{r message=FALSE, warning=FALSE, include=FALSE}
rm(list=ls()) #I always start scritps this way to make sure I have a clean R environment
library('tidyr')
library('dplyr')
library('metacoder')
library('ggplot2')
library('agricolae')
library('vegan')
library('MicrobiotaProcess')
library('phyloseq')
library('ggtree')

obj <- readRDS('data/taxmap_object.rds') #loads the taxmap object created in script 02_metacoder_heat_trees

obj %>%  metacoder::filter_taxa(taxon_names %in% c("Lepidoptera"),#here is to fliter the figure by groups
              subtaxa = TRUE) -> leps #we will create separate files for each order as this simplifies downstream analysis in microbiotaprocess - until I find a way to filter taxa on the mpse object directly.

obj %>%  metacoder::filter_taxa(taxon_names %in% c("Coleoptera"),#here is to fliter the figure by groups
              subtaxa = TRUE) -> coleo
obj %>%  metacoder::filter_taxa(taxon_names %in% c("Diptera"),#here is to fliter the figure by groups
              subtaxa = TRUE) -> dips
obj %>%  metacoder::filter_taxa(taxon_names %in% c("Hymenoptera"),#here is to fliter the figure by groups
              subtaxa = TRUE) -> bees #i know its hymenoptera
obj %>%  metacoder::filter_taxa(taxon_names %in% c("Hemiptera"),#here is to fliter the figure by groups
              subtaxa = TRUE) -> hemi
obj %>%  metacoder::filter_taxa(taxon_names %in% c("Blattodea"),#here is to fliter the figure by groups
              subtaxa = TRUE) -> blats 

sample <- read.csv('data/location_ctrl.csv')
```


```{r simpleBoxplotANOVAbetweenSeason}
sample$inv_simp <- diversity(obj$data$tax_data[, sample$sampleID],
                             index = "invsimpson",
                             MARGIN = 2) # What orietation the matrix is in
ggplot(sample, aes(x = SEASON, y = inv_simp)) +
  geom_boxplot()
anova_result <- aov(inv_simp ~ SEASON, sample)
summary(anova_result)
tukey_result <- HSD.test(anova_result, "SEASON", group = TRUE)
print(tukey_result)

group_data <- tukey_result$groups[order(rownames(tukey_result$groups)),]
ggplot(sample, aes(x = SEASON, y = inv_simp)) +
  geom_text(data = data.frame(),
            aes(x = rownames(group_data), y = max(sample$inv_simp) + 1, label = group_data$groups),
            col = 'black',
            size = 10) +
  geom_boxplot() +
  ggtitle("Inverse Simpson diversity") +
  xlab("Season") +
  ylab("Inverse simpson index")
```

We can also see differences between sampling days.

```{r simpleBoxplotANOVAbetweenDays}
ggplot(sample, aes(x = day, y = inv_simp)) +
  geom_boxplot()
anova_result <- aov(inv_simp ~ day, sample)
summary(anova_result)
tukey_result_day <- HSD.test(anova_result, "day", group = TRUE)
print(tukey_result_day)

group_data_day <- tukey_result_day$groups[order(rownames(tukey_result_day$groups)),]
ggplot(sample, aes(x = day, y = inv_simp)) +
  geom_text(data = data.frame(),
            aes(x = rownames(group_data_day), y = max(sample$inv_simp) + 1, label = group_data_day$groups),
            col = 'black',
            size = 10) +
  geom_boxplot() +
  ggtitle("Inverse Simpson diversity") +
  xlab("Day") +
  ylab("Inverse simpson index")
```

No difference between sampling days.
We can also calculate several diversity metrics for sampling season and day using phyloseq but we must convert the taxmap object 'obj' to phyloseq 
```{r multipleDiversityIndices}
ps_obj <- metacoder::as_phyloseq(obj,
                      otu_table = "tax_data",
                      otu_id_col = "bin_uri",
                      sample_data = sample,
                      sample_id_col = "sampleID")

#normally, I load every package I need at the start of the script, but this may cause function masking problems (e.g. both MicrobiotaProcess and Metacoder has a 'as_phyloseq' function and you have to specify to R which package you want to use -  see above: metacoder::as_phyloseq - this means I am telling R to use the 'as_phyloseq' function from the metacoder package)
plot_richness(ps_obj, color = "SEASON", x = "site") #phyloseq function
plot_richness(ps_obj, color = "day", x = "SEASON")

```

```{r warning=FALSE}
library(microViz)
ps_obj2 <- tax_mutate(ps_obj, Rank_0 = "Animalia", .before =1)
#Note that there is an issue with ps_obj and the way the data has been exported and parsed from mBrave. The issue is that when parsing, Metacoder took the ; as a separation between taxonomic rank, but we do not have a 'Kingdom' or 'root' rank. Straight up to Phyllum. This added some issues downstream, exclusively in the MicroBiotaProcess pipelines. The line above adds this single column to the begining of the tax_table in the phyloseq object. Use this for all MicroBiotaProcess analyeses. 

#ALTERNATIVELY, we could edit the original data sheet used in script 01 to inlcude 'Kingdom'  - I thought this was easier.

```

Figures above OK but we can do better.
I am using the MicrobiotaProcess next

```{r MBPPlotsDiversityIndices}
alphaobj <- get_alphaindex(ps_obj2)
p_alpha <- ggbox(alphaobj, geom="violin", factorNames="SEASON", indexNames = c('Observe', 'Shannon', 'Simpson'),  signifmap = TRUE) +
  scale_fill_manual(values=c("orange", "darkcyan"))+
  theme(strip.background = element_rect(colour=NA, fill="grey"))
p_alpha
```
And look at rarefaction curves for both seasons:
```{r MBPRarefactionCurvesPerSeason}
alphaobj <- get_alphaindex(ps_obj2)
head(as.data.frame(alphaobj))

rareres <- get_rarecurve(obj=ps_obj2, chunks=400)

prare2 <- ggrarecurve(obj=rareres,
                      factorNames="SEASON",
                      shadow=FALSE,
                      indexNames="Observe"
) +
  scale_color_manual(values=c("orange", "darkcyan"))+
  theme_bw()+
  theme(axis.text=element_text(size=8), panel.grid=element_blank(),
        strip.background = element_rect(colour=NA,fill="grey"),
        strip.text.x = element_text(face="bold"))

prare2
```

We can also do a Principal Coordinate Analysis to see not onlyl the differences between seasons, but what BINs are the main drivers of these differences

```{r MBPPCoAPlots}
# distmethod
# "unifrac",  "wunifrac", "manhattan", "euclidean", "canberra", "bray", "kulczynski" ...(vegdist, dist)
pcoares <- get_pcoa(obj=ps_obj2, distmethod="bray", method="hellinger")
# Visualizing the result
pcoaplot1 <- ggordpoint(obj=pcoares, biplot=TRUE, speciesannot=TRUE,
                        factorNames=c("SEASON"), ellipse=TRUE) +
  scale_color_manual(values=c("orange", "darkcyan")) +
  scale_fill_manual(values=c("orange", "darkcyan"))
# first and third principal co-ordinates
pcoaplot2 <- ggordpoint(obj=pcoares, pc=c(1, 3), biplot=TRUE, speciesannot=TRUE,
                        factorNames=c("SEASON"), ellipse=TRUE) +
  scale_color_manual(values=c("orange", "darkcyan")) +
  scale_fill_manual(values=c("orange", "darkcyan"))
pcoaplot1 | pcoaplot2
```

```{r MBPTaxonAbundanceTOP10}

#IMPORTANT - FROM HERE ON ITS CRITICAL TO USE PS_OBJ2 IN CASE YOU DIDN'T BEFORE

classtaxa <- get_taxadf(obj=ps_obj2, taxlevel=4)
# The 10 most abundant taxonomy will be visualized by default (parameter `topn=10`). 
pclass <- ggbartax(obj=classtaxa, facetNames="SEASON", topn=10) +
  xlab(NULL) +
  ylab("relative abundance (%)") +
  scale_fill_manual(values=c(colorRampPalette(RColorBrewer::brewer.pal(12,"Set3"))(31))) +
  guides(fill= guide_legend(keywidth = 0.5, keyheight = 0.5))

#note the flag "count=TRUE", this shows now total reads, rather than proportion %
pclass2 <- ggbartax(obj=classtaxa, count=TRUE, facetNames="SEASON", topn=15) +
  xlab(NULL) +
  ylab("count reads") +
  scale_fill_manual(values=c(colorRampPalette(RColorBrewer::brewer.pal(12,"Set3"))(31))) +
  guides(fill= guide_legend(keywidth = 0.5, keyheight = 0.5))


pclass 

pclass2
```


These following chunks might be best to compare metabarcoding vs traditional data but its OK to visualize below.
Way too many species difference between both sampling strategies and so the plots are messy  - after Kruskal, Wilcox and LDA, 264 taxa are discriminative between wet and dry seasons.

```{r warning=FALSE}
library('coin')#for kruskal and wilcox test
# Since the effect size was calculated by randomly re-sampling, 
# the seed should be set for reproducibly results.
set.seed(1024)
deres <- diff_analysis(obj = ps_obj2, classgroup = "SEASON",
                       mlfun = "lda",
                       filtermod = "pvalue",
                       firstcomfun = "kruskal_test",
                       firstalpha = 0.05,
                       strictmod = TRUE,
                       secondcomfun = "wilcox_test",
                       subclmin = 3,
                       subclwilc = TRUE,
                       secondalpha = 0.01,
                       lda=3,
                       action = "add")
deres
```

```{r MessyFigure_TaxoTree}
diffclade_p <- ggdiffclade(
  obj=deres, 
  alpha=0.2, 
  linewd=0.15,
  skpointsize=0.2, 
  layout="radial",
  cladetext = 0.7,
  taxlevel=4, #taxonomy level from 1 to 8 kingdome:phylum:class:order:family:subfamily:genus:species
  removeUnkown=TRUE,
  reduce=TRUE # This argument is to remove the branch of unknown taxonomy.
) +
  scale_fill_manual(
    values=c("orange", "darkcyan")
  ) +
  guides(color = guide_legend(
    keywidth = 0.1, 
    keyheight = 0.6,
    order = 5,
    ncol=3)
  ) +
  theme(
    panel.background=element_rect(fill=NA),
    legend.position="right", 
    plot.margin=margin(0,0,0,0),
    legend.spacing.y=unit(0.02, "cm"), 
    legend.title=element_text(size=7),
    legend.text=element_text(size=6), 
    legend.box.spacing=unit(0.02,"cm")
  )
diffclade_p
```


```{r BoxplotFIlteredOrder}
ps_obj2 %>% as.MPSE() %>% mp_rrarefy() %>% mp_diff_analysis(.abundance=RareAbundance, .group=SEASON, action='get') %>% dplyr::filter(grepl("^o_", f)) %>% ggdiffbox(colorlist=c("darkcyan", "orange"), notch = FALSE)
```
It is not clear to me why we are still missing some ordersin the fiugre above... They are on ps_obj2 and I wonder if its just the fact that thsoe orders do not have a significant difference between seasons...

```{r boxplotAll_VeryMessy}
diffbox <- ggdiffbox(obj=deres, box_notch=FALSE, 
                     colorlist=c("darkcyan", "orange"), l_xlabtext="relative abundance", ytextsize = 0.5)
diffbox
```

```{r EffectSize_not_good}
es_p <- ggeffectsize(obj=deres, 
                     lineheight=0.1,
                     linewidth=0.3, ytextsize = 0.3) + 
  scale_color_manual(values=c("orange", "darkcyan")) 

es_p
```

All these figures look rather messy, better to separate them between orders for more clarity in the following script.